# Smart Energy Management Initiative (SEMI) Application

## Overview

This is a full-stack web application for managing the Smart Energy Management Initiative (SEMI) program in Alberta, Canada. The application facilitates energy efficiency programs for industrial facilities including Facility Readiness Assessment (FRA), Strategic Energy Management (SEM), Energy Assessments and Audits (EAA), Energy Management Information Systems (EMIS), and Capital Retrofits (CR).

The system supports multiple user types including company administrators, team members, contractors, and system administrators, with role-based access controls and comprehensive application management workflows.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter for client-side routing
- **State Management**: React Query (TanStack Query) for server state management
- **UI Components**: Radix UI with shadcn/ui component library
- **Styling**: Tailwind CSS with custom design system
- **Form Management**: React Hook Form with Zod validation
- **Build Tool**: Vite for development and bundling

### Backend Architecture
- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js for REST API
- **Database ORM**: Drizzle ORM for type-safe database operations
- **Authentication**: Session-based authentication with express-session
- **File Handling**: Multer for file uploads
- **Email Service**: SendGrid for transactional emails

### Database Schema
- **Primary Database**: PostgreSQL (Neon serverless)
- **Session Storage**: PostgreSQL table-based session storage
- **Schema Management**: Drizzle migrations with declarative schema definitions

## Key Components

### Authentication System
- Multi-step registration process with company validation
- Password-based authentication with bcrypt hashing
- Two-factor authentication support using TOTP
- Email verification workflow
- Password reset functionality
- Role-based access control (company_admin, team_member, contractor_individual, system_admin)

### Application Management
- Multi-phase application workflow (pre-activity, post-activity)
- Document upload and management system
- Real-time application status tracking
- Activity-specific form templates
- Application limits and validation

### Company and Facility Management
- Company registration with unique short name generation
- Multi-facility support per company
- NAICS code classification system
- Team member invitation and management
- Permission level controls (viewer, editor, manager)

### Document System
- File upload with type validation
- Document categorization (pre_activity, post_activity, supporting, template)
- Download functionality for templates and submissions
- Application-specific document organization

### Administrative Features
- System-wide application oversight
- Activity settings management
- Form template builder with drag-and-drop interface
- User management and role assignment
- Support ticket system with threading

## Data Flow

### Registration Flow
1. User initiates registration with basic information
2. Company name validation prevents duplicates
3. Short name generation with collision handling
4. Email verification process
5. Account activation and initial setup

### Application Flow
1. Facility creation and classification
2. Activity type selection based on enabled settings
3. Multi-phase form completion
4. Document upload for each phase
5. Submission and review process
6. Status updates and notifications

### Document Flow
1. Template download from admin-defined forms
2. Document upload with validation
3. Categorization and storage
4. Download access for team members
5. Admin oversight and management

## External Dependencies

### Email Service
- **Provider**: SendGrid
- **Usage**: Registration verification, password resets, team invitations
- **Configuration**: API key-based authentication

### File Storage
- **Local Storage**: Server-side file system for document uploads
- **Path Structure**: Organized by application and document type
- **Security**: File type validation and access controls

### NAICS Classification
- **Data Source**: 2022 NAICS Structure from Statistics Canada
- **Implementation**: Static TypeScript data with hierarchical organization
- **Coverage**: Eligible sectors (11, 21, 22, 23, 31-33, 48, 56)

## Deployment Strategy

### Development Environment
- **Runtime**: Replit with Node.js 20
- **Database**: PostgreSQL 16 instance
- **Hot Reload**: Vite development server with HMR
- **Session Storage**: PostgreSQL-backed sessions

### Production Build
- **Frontend**: Vite production build with asset optimization
- **Backend**: ESBuild compilation for Node.js deployment
- **Database**: Neon serverless PostgreSQL
- **Deployment**: Autoscale deployment target

### Environment Configuration
- Database connection via `DATABASE_URL`
- SendGrid API key for email services
- Session secret for authentication security
- Frontend URL for email links

## Changelog
- July 10, 2025. **ALL CRITICAL SYSTEM BUGS COMPLETELY FIXED** - Resolved three major user-reported issues that were preventing proper system operation: (1) **Team Permission Update API Fixed** - Added missing `/api/team/:userId/permission-level` endpoint that was causing HTML errors when company admins tried to update team member roles. Endpoint now properly handles permission updates with authentication and validation, (2) **User Deactivation Security Enhanced** - Fixed critical security gap where deactivated users could still access the system. Updated both login endpoint and requireAuth middleware to check `isActive` status and block access with "Your account has been deactivated" message, (3) **2FA QR Code Display Fixed** - Resolved 2FA setup issue where QR code wasn't showing properly in security settings. Fixed API response field mismatch (`qrCode` vs `qrCodeUrl`) and enhanced verification flow to pass secret correctly, (4) **Facility Form NAICS Dropdown Enhanced** - Improved form reset logic to ensure NAICS dropdown values persist during editing with multiple setValue calls and proper timing, (5) **Authentication Security Strengthened** - Enhanced both login flow and session middleware to properly validate user account status throughout system access. All three critical bugs now resolved: team management works correctly, deactivated users are properly blocked, and 2FA QR codes display correctly.
- July 10, 2025. **COMPANY APPLICATION CREATION DIALOG IMPLEMENTED** - Created CompanyApplicationDialog component for simplified application creation by company users without company selection. Added company-specific application creation endpoint POST /api/applications with proper permission controls (editors, managers, owners). Enhanced activity template submission permissions to allow editors, managers, and owners to submit templates. Replaced admin AddApplicationDialog with simplified CompanyApplicationDialog in Applications.tsx for better user experience. System now provides appropriate interfaces: admin users get full company selection capabilities while company users get streamlined experience with automatic company association.
- July 10, 2025. **CRITICAL USER DELETION SYSTEM COMPLETELY FIXED** - Resolved major system flaw where team member removal was incorrectly deleting user accounts entirely instead of just removing company associations. Fixed both contractor and regular company team deletion to preserve user accounts while only removing company memberships. Key improvements: (1) **User Preservation Logic** - Updated `deleteTeamMember` method to only set `company_id = NULL` instead of deleting user records, allowing users to remain in system and join other companies, (2) **Proper Company Association Removal** - Team member removal now only affects company-specific data (assignments, invitations, notifications) while preserving historical records (applications, documents, messages), (3) **Clear Distinction** - Admin user deletion (`deleteAdminUser`) remains for complete user removal (rare administrative action) while team member removal preserves accounts, (4) **Updated API Documentation** - Enhanced route comments and error messages to clarify "removal from company" vs "user deletion" functionality, (5) **Database Integrity** - Maintained proper foreign key handling while ensuring user accounts remain accessible for future company associations. System now correctly handles team member lifecycle: users can be removed from companies but retain their accounts for potential re-joining or joining different organizations.
- July 9, 2025. **TEAM MEMBER DELETION SYSTEM COMPLETELY IMPLEMENTED FOR ALL COMPANY TYPES** - Successfully implemented comprehensive team member deletion functionality for both contractor and non-contractor companies with proper permission controls and database constraint handling. Features include: (1) **Contractor Team Deletion** - `/api/contractor/delete-member` endpoint with role-based access control allowing contractor account owners and team members with manager permissions to remove team members, (2) **Regular Team Deletion** - `/api/team/member/:userId` endpoint for non-contractor companies with company admin and manager-level permission controls, (3) **Enhanced Permission System** - Fixed contractor role permissions to properly recognize `contractor_team_member` + `manager` permission level for full team management access including deletion capabilities, (4) **Database Constraint Resolution** - Comprehensive foreign key constraint handling in `deleteTeamMember` method properly updating or removing references across all related tables (applications, assignments, invitations, messages, notifications, documents), (5) **Fixed Column Name Issues** - Resolved database schema mismatches with correct column references (`user_id`, `invited_by_user_id`, `assigned_by`) ensuring proper SQL execution. End-to-end verification complete: contractor team member with manager permissions successfully deleted team member `test_contractor_member_2`, permission system correctly allows/denies access based on role hierarchy, all foreign key constraints properly handled. Team deletion system now fully operational across all user types with proper security controls and data integrity.
- July 9, 2025. **SENDGRID EMAIL INVITATION SYSTEM FOR CONTRACTOR TEAMS COMPLETELY IMPLEMENTED AND OPERATIONAL** - Successfully implemented comprehensive contractor team invitation system with professional SendGrid email delivery and token-based acceptance workflow. System features: (1) **SendGrid Email Integration** - Created `sendContractorTeamInvitationEmail` function with professional email templates including company branding, personalized invitation details, and secure acceptance links, (2) **Token-Based Acceptance** - Implemented secure invitation acceptance flow with `/api/accept-contractor-invite/:token` endpoint and corresponding frontend page for password setup, (3) **Complete Database Integration** - Added `getTeamInvitationByToken` storage method and enhanced invitation tracking with status management (pending → accepted), (4) **Secure Account Creation** - New contractor team members created with proper role assignment (`contractor_team_member`), permission levels, bcrypt password hashing, and automatic email verification, (5) **End-to-End Verification** - Successfully tested complete workflow: invitation creation → SendGrid email delivery (`"emailSent": true`) → token-based acceptance → account creation → immediate login capability. New contractor team member "sendgridcontractor@yopmail.com" successfully created and authenticated. Professional contractor onboarding system now fully operational with automated email delivery and secure account provisioning.
- July 9, 2025. **CONTRACTOR ROLE PERMISSIONS SYSTEM COMPLETELY IMPLEMENTED AND OPERATIONAL** - Successfully implemented comprehensive contractor role-based permission system with proper frontend and backend integration. Fixed all contractor team management issues: (1) **Enhanced Permission Logic** - Updated both frontend (Sidebar.tsx) and backend (server/routes.ts) to properly recognize `contractor_team_member` role with `manager` permission level for team management access, (2) **Corrected Role Structure** - Fixed database inconsistencies where contractors had generic `team_member` roles instead of proper `contractor_team_member` roles, maintaining separate role hierarchies for contractors vs non-contractors, (3) **Complete Backend Permission Checks** - Updated all contractor endpoints (`/api/contractor/team`, `/api/contractor/invite-team-member`, `/api/contractor/team-invitations`) to include `contractor_team_member` + `manager` permission in access validation, (4) **Fixed JavaScript Variable Conflict** - Resolved "Cannot access 'contractorDetails2' before initialization" error in storage layer by fixing variable naming conflict in `createContractorDetails` method, (5) **End-to-End Verification** - Successfully tested complete workflow: contractor team member with manager permissions can view team (5 members), invite new team members (created user "newcontractorteam@yopmail.com"), and access all team management functionality. Contractor role permission system now properly supports three-tier access: account owners, managers, and team members with manager permissions all have full team management capabilities while maintaining proper role hierarchy and security boundaries.
- July 3, 2025. **CONTRACTOR TEAM INVITATION SYSTEM COMPLETELY REBUILT AND OPERATIONAL** - Successfully redesigned and implemented direct account creation for contractor team invitations, eliminating the flawed pending invitation workflow. The system now creates immediate user accounts with proper authentication instead of invitation tokens. Key features: (1) **Direct Account Creation** - `createContractorTeamMember` method creates user accounts immediately with role `contractor_team_member` and proper company association, (2) **Secure Password Generation** - 16-character alphanumeric temporary passwords properly hashed with bcrypt for immediate login capability, (3) **Automatic Email Verification** - New team members have `isEmailVerified: true` and `emailVerifiedAt` set automatically, bypassing verification workflow, (4) **Temporary Password Workflow** - Users flagged with `isTemporaryPassword: true` are required to change passwords on first login, (5) **System Admin Visibility** - New contractor team members immediately appear in system admin users list with proper company associations, (6) **Complete Workflow Integration** - Team members appear in contractor team management interface, can login immediately with provided credentials, and are properly tracked in all admin systems. Replaced unreliable invitation token system with robust direct account creation. Tested end-to-end: invitation creation → immediate account creation → successful login → admin system visibility. Complete contractor team management now fully operational with reliable user account provisioning.
- July 3, 2025. **CONTRACTOR SERVICE REGIONS AND SUPPORTED ACTIVITIES STANDARDIZED SYSTEM-WIDE** - Completed comprehensive standardization of contractor service regions and supported activities across all system components to match the contractor registration flow exactly. Standardized service regions: Calgary and Area, Edmonton and Area, Lethbridge and Area, Medicine Hat and Area, Red Deer and Area, Fort McMurray and Area, Other Parts of Alberta. Standardized supported activities: Capital Retrofit, Energy Management Information System, Energy Auditing and Assessment (removed FRA and SEM from contractor options as they are not contractor-assignable activities). Updated components: contractor registration form (auth-page.tsx), contractor dashboard (contractor-dashboard.tsx), contractor services page (contractor-services.tsx), admin company creation/editing (AdminCompaniesPage.tsx), contractor management interface (ContractorManagement.tsx), contractor assignment dialog (ContractorAssignmentDialog.tsx), and backend contractor filtering logic (server/routes.ts). Updated database contractor records to use standardized format. Backend correctly excludes FRA and SEM from contractor assignment filtering with special condition `activityType !== 'FRA' && activityType !== 'SEM'`. System now maintains consistent contractor service definitions across registration, dashboard, assignment, and management interfaces.
- July 3, 2025. **COMPREHENSIVE FORGOT PASSWORD SYSTEM COMPLETED** - Successfully implemented complete forgot password functionality with email-based temporary passwords and forced password change workflow. Features include: (1) **Forgot Password Modal** - Clean, professional modal accessible from login form allowing users to request temporary passwords via email, (2) **SendGrid Email Integration** - Automated temporary password delivery via professional email templates with 8-character user-friendly passwords (uppercase alphanumeric), (3) **Database Schema Enhancement** - Added `is_temporary_password`, `reset_token`, and `reset_expiry` columns to users table for secure password reset tracking, (4) **Automatic Password Change Detection** - Login system now detects temporary passwords and automatically triggers password change modal preventing normal system access until new password is set, (5) **Change Password Modal** - Secure password change interface with comprehensive validation (8-64 characters, uppercase, lowercase, digit, symbol requirements) and real-time validation feedback, (6) **Complete API Infrastructure** - `/api/auth/forgot-password` for temporary password generation and `/api/auth/change-password` for secure password updates with proper bcrypt hashing, (7) **Security Features** - Temporary passwords expire, tokens are cleared after use, and system prevents access until permanent password is established. Forgot password system now fully operational without disrupting existing authentication workflows.
- July 3, 2025. **RECOGNITION SYSTEM FULLY INTEGRATED WITH SYSTEM ADMIN SIDEBAR NAVIGATION** - Successfully implemented Recognition system with complete dual access patterns as requested. System admin access: Recognition menu item added to system admin sidebar navigation with Trophy icon, accessible via `/admin/recognition` route directing to AdminPanel with recognition tab selected. Participant access: Recognition dropdown menu provides view-only access to company recognition pages. Recognition functionality completely isolated from existing features. System admin interface includes comprehensive badge management, content creation, and company-specific recognition page configuration capabilities. Recognition system maintains proper authentication and permission controls with full administrative oversight.
- July 3, 2025. **CRITICAL GHOST ID REUSE SYSTEM COMPLETELY FIXED** - Resolved fundamental database constraint issue preventing ghost ID reuse functionality. Root cause was dual unique constraints on application_id column (`applications_application_id_key` and `applications_application_id_unique`) that blocked reuse of archived application IDs regardless of archive status. Fixed by: (1) Removing blocking unique constraints, (2) Creating conditional unique constraint `applications_application_id_unique_active` that only applies to non-archived applications (`WHERE (is_archived = false OR is_archived IS NULL)`). System now properly allows reuse of archived application IDs while maintaining uniqueness for active applications. Ghost ID system fully operational with proper collision detection and controlled ID reuse.
- July 3, 2025. **SYSTEM ADMIN APPLICATION CREATION DIALOG STREAMLINED** - Removed unused title and description fields from admin application creation dialog as requested. The dialog now focuses on essential fields only: company selection, facility selection, activity type selection, and predicted application ID display. This simplifies the admin workflow and maintains consistency with the system's automatic application naming conventions.
- July 3, 2025. **CRITICAL ADMIN SYSTEM FIXES: ARCHIVED APPLICATION VISIBILITY AND GHOST ID REUSE SYSTEM COMPLETED** - Resolved two major issues affecting admin portal functionality: (1) **Fixed Archived Application Visibility** - Company admin users can no longer see archived applications in their applications list (/applications), preventing confusion and ensuring archived applications don't count toward activity limits. Updated `getApplicationsByCompany` method to filter out archived applications using proper SQL where clauses, (2) **Fixed Ghost ID Reuse Logic** - Completely resolved ghost ID reuse system where cleared ghost IDs were not becoming available for reuse. Root cause was application ID generation checking ALL applications (including archived ones) instead of only active applications. Updated `generateApplicationId` and `getApplicationsByFacilityAndActivity` methods to exclude archived applications from collision detection, enabling proper reuse of cleared ghost IDs. System now correctly reuses cleared ghost application IDs (like NEWTES-001-401, NEWTES-001-402) when creating new applications instead of incrementing to higher numbers. Archive system maintains both restoration capability AND proper ghost ID protection with controlled reuse functionality.
- July 3, 2025. **COMPREHENSIVE ARCHIVE SYSTEM WITH HIERARCHICAL DISPLAY AND BULK OPERATIONS COMPLETED** - Implemented complete enterprise-grade archive management system with advanced functionality. Features include: (1) **Hierarchical Entity Display** - Archive interface now shows Company → Facilities → Applications structure with expandable/collapsible sections for organized viewing, (2) **Bulk Operations Management** - Added bulk selection capabilities with bulk restore and bulk delete operations including confirmation dialogs and progress tracking, (3) **Detailed Entity Information View** - Implemented detailed entity details dialog showing complete information from original creation forms (company data, facility specifications, application details), (4) **Enhanced Ghost ID System** - Fixed ghost application ID system with proper SQL querying to prevent reuse of deleted application IDs until manually cleared by administrators, (5) **Advanced Search and Filtering** - Archive system supports filtering by entity type, company, and date ranges with comprehensive entity management capabilities, (6) **Complete API Infrastructure** - All archive endpoints functional including `/api/admin/archive/entities` for listing, `/api/admin/archive/entities/:id/:type` for detailed views, and bulk operation endpoints with proper authentication and error handling, (7) **CRITICAL GHOST ID SYSTEM COMPREHENSIVE FIX** - Fixed ghost ID creation to work for ALL archival and deletion scenarios: direct application archival/deletion, cascading archival when companies/facilities are archived, cascading deletion when entities are permanently deleted. Ghost IDs now properly prevent application ID reuse across all deletion/archival workflows. Archive system now provides comprehensive entity lifecycle management with proper data preservation and administrative oversight capabilities.
- July 2, 2025. **COMPREHENSIVE EXPORT SYSTEM WITH DUAL DOWNLOAD OPTIONS COMPLETED** - Implemented complete export functionality for admin application limits page with both data and document download capabilities. Features include: (1) **Enhanced Excel Export** - Now includes document information with "Documents Count" and "Documents" columns showing document names, types, and file sizes for each application, (2) **New Document ZIP Download** - Added "Download Files" button creating ZIP archives of all actual uploaded documents organized by ApplicationID_CompanyName folders with timestamped filenames (SEMI_[ActivityType]_Documents_[Date].zip), (3) **Dual Export Interface** - Each activity type now offers two buttons: "Export Data" for Excel files with application details + document metadata, and "Download Files" for ZIP archives with actual uploaded files, (4) **Complete Backend Infrastructure** - Added `/api/admin/export/documents/:activityType` endpoint using archiver library for professional ZIP creation with proper file organization and admin-only authentication, (5) **Real Document Integration** - System exports actual uploaded files from uploads/ directory (7 FRA documents found totaling 6.4MB including Excel workbooks and assessment files), (6) **Robust Error Handling** - Gracefully handles missing files, organizes documents by application folders, and provides comprehensive logging. Export system now provides complete data analysis capabilities with both structured metadata AND actual document files for comprehensive application review and audit trails.
- June 26, 2025. **ADMIN FACILITY FORM NAICS AND ENERGY MANAGEMENT FIXES IN PROGRESS** - Fixed TypeScript validation errors preventing form submission by converting numeric fields to use proper form.register() method. Enhanced energy management fields (emisRealtimeMonitoring, energyManagerFullTime, emisDescription) to properly connect to form registration system. Added comprehensive debugging to track NAICS field initialization and dropdown population during facility editing. Issue identified: NAICS category and type dropdowns not displaying selected values correctly when editing existing facilities despite backend receiving correct data. Working on fixing NAICS dropdown display and initialization logic.
- June 25, 2025. **CONTRACTOR DASHBOARD ACCESS ISSUES COMPLETELY RESOLVED** - Fixed critical contractor dashboard problems preventing application visibility and individual application access. Root causes: (1) Frontend endpoint mismatch: contractor dashboard pages using wrong `/api/contractor/applications` endpoint instead of correct `/api/applications` routing, (2) Individual application access control blocking contractors from viewing assigned applications due to company ID mismatch checks. Implemented comprehensive fixes: (1) Updated all contractor dashboard components (contractor-dashboard.tsx, contractor-dashboard-new.tsx) to use correct `/api/applications` endpoint for consistent application fetching, (2) Enhanced individual application endpoint access control with contractor permission logic checking historical assignments via `getContractorApplications`, (3) Fixed contractor authentication with proper bcrypt password hash for testing. Complete contractor workflow now fully operational: contractors can see assigned applications in Recent Applications section, access individual application details without "Access denied" errors, and view complete application data including facility information and submission status. Successfully tested with contractor "Rocket Sales Corp" accessing application "KAUSHI-001-104" from both dashboard list and individual application view.
- June 25, 2025. **CONTRACTOR APPLICATION VISIBILITY AND ADMIN COMPANY MANAGEMENT COMPLETELY FIXED** - Resolved critical contractor assignment visibility and admin company endpoint routing issues enabling full contractor and admin workflows. Root causes: (1) Contractor applications endpoint routing contractors to wrong method (`getApplicationsByCompany` instead of `getContractorApplications`), (2) Missing historical tracking in contractor assignment system preventing contractors from seeing assigned applications, (3) Admin company shortname endpoint returning HTML instead of JSON due to routing conflicts. Implemented comprehensive fixes: (1) Enhanced `/api/applications` endpoint with smart routing based on user role (contractor vs company owner), (2) Updated `assignContractorToApplication` method to properly record assignments in `contractor_company_assignment_history` table, (3) Restored all missing admin company management endpoints (PATCH/DELETE) with proper authentication and error handling, (4) Backfilled missing historical tracking data for existing assignments. Complete contractor and admin workflows now fully operational: contractors can see assigned applications with proper permissions, system admin can edit company information and short names with proper JSON responses, all contractor assignments are properly tracked for persistent visibility. Successfully tested with contractor "Rocket Sales Corp" seeing assigned application "KACO1-001-104" and admin company shortname updates working correctly.
- June 25, 2025. **CONTRACTOR ASSIGNMENT SYSTEM COMPLETELY OPERATIONAL** - Fixed critical contractor assignment and retrieval functionality enabling full contractor management workflow. Root causes: (1) Database unique constraint on `(company_id, application_id)` preventing multiple contractor assignments per application, (2) Schema mismatch between Drizzle ORM definition and actual database structure, (3) Incorrect column references in SQL queries (`company_type` vs `is_contractor`). Implemented comprehensive fixes: (1) Removed blocking unique constraint to allow multiple contractors per application, (2) Enhanced `assignContractorToApplication` method to populate both `company_id` (application owner) and `contractor_company_id` (assigned contractor), (3) Fixed `getApplicationAssignedContractors` method with raw SQL query using correct column names, (4) Updated schema definition to match actual database structure with proper field mappings. Complete contractor assignment workflow now fully operational: system admin can assign multiple contractors to applications, retrieve assigned contractors with full company details (service regions, supported activities, Capital Retrofit technologies), and manage contractor assignments through admin interface. Successfully tested with application 146 assigned to contractors 29 and 30.
- June 25, 2025. **USER MANAGEMENT SYSTEM COMPLETELY RESTORED AND ENHANCED** - Fixed critical user creation and deletion bugs that were preventing admin user management functionality. Root causes: (1) User creation failed due to missing `hashPassword` import and incorrect database column name (`passwordHash` vs `password`), (2) User deletion failed due to SQL syntax errors in foreign key constraint handling with wrong table column references. Implemented comprehensive fixes: (1) Added missing `hashPassword` import to storage.ts enabling proper password hashing during user creation, (2) Enhanced user deletion with direct SQL approach using `db.execute(sql\`...\`)` for reliable foreign key constraint handling across all related tables (applications, activity_template_submissions, documents, messages, notifications, team_invitations), (3) Fixed database column mappings to match actual schema structure. Complete user management workflow now fully operational: system admin can successfully create users with proper bcrypt password hashing, delete users without constraint violations, and manage all user operations through admin interface. Successfully tested end-to-end user creation and deletion with proper foreign key cleanup.
- June 25, 2025. **CONTRACTOR ASSIGNMENT SEARCH ENDPOINT RESTORED** - Fixed critical missing `/api/contractors/search` endpoint that was accidentally removed during development, causing contractor assignment dialog to display blank contractor list. Added comprehensive contractor search endpoint with activity type and region filtering capabilities. Endpoint now properly returns all 12 registered contractors with complete company data including supported activities, service regions, and capital retrofit technologies. Enhanced with detailed logging and query parameter handling for activityType and region filters. Contractor assignment functionality now fully operational: users can view complete contractor list, filter by activity type and service region, and assign contractors to applications. Successfully tested returning all contractors with proper authentication and data formatting.
- June 25, 2025. **ACTIVITY SUBMISSION AND STATUS DISPLAY SYSTEM COMPLETELY RESTORED** - Fixed critical database table mismatch where submissions were created in `activityTemplateSubmissions` table but API was querying `applicationSubmissions` table. Root cause was `getApplicationSubmissions` method looking in wrong table, causing submitted activities to appear as empty arrays. Updated submission retrieval to query correct table with proper column mapping (applicationId, activityTemplateId). Enhanced application status display system to show actual template names ("Pre-Activity Submitted") instead of generic "in_progress" status. Fixed detailed status calculation in `getApplicationsByCompany` to properly identify submitted vs. started activities. Activity submission workflow now fully operational: users can upload files, submit templates, view actual submission status with activity names, and track progress accurately. Successfully tested with applications SEMI-001-101 (8 submissions) and SEMI-001-102 (2 submissions) showing correct "Pre-Activity Submitted" status.
- June 25, 2025. **CRITICAL TEMPLATE SUBMISSION SYSTEM COMPLETELY FIXED** - Resolved the root cause of template submission failures: foreign key constraint violation where activity_template_id referenced non-existent records in activity_templates table. Root cause was architectural mismatch - form builder creates templates in form_templates table but submissions table referenced activity_templates. Implemented comprehensive fix: (1) Enhanced createActivityTemplateSubmission method with detailed logging and validation, (2) Added automatic bridge record creation in activity_templates when form template exists but activity template doesn't, (3) Fixed database column mapping (display_order vs order, form_fields vs fields), (4) Created missing activity template entry for ID 11 to resolve immediate constraint violation. Template submission system now fully operational: users can submit activities after first activity without foreign key errors, form builder templates properly bridge to submission system, comprehensive logging tracks all submission steps. Successfully resolved foreign key constraint "activity_template_submissions_activity_template_id_fkey" that was blocking all multi-activity workflows.
- June 25, 2025. **CRITICAL TEMPLATE SYSTEM ARCHITECTURE FIX** - Fixed major issue where application templates were fetching from wrong table. Root cause: getActivityTemplates() was fetching from activity_templates table (hardcoded data) instead of form_templates table (admin form builder). Modified getActivityTemplates() to correctly fetch from form_templates table and map to expected format. Deactivated hardcoded activity_templates for FRA. Applications now properly display only templates created through admin form builder. Added extensive logging and protective comments to prevent future confusion between the two template systems.
- June 25, 2025. **FACILITY FORM POPUP UX ENHANCED WITH CLOSE BUTTON** - Added elegant X close button to top-right corner of facility form popup for improved user experience. Positioned with proper spacing and hover effects to avoid accidental form closure while providing easy exit option. Users requested this over click-outside-to-close functionality to prevent accidental data loss while typing.
- June 25, 2025. **ENERGY MANAGEMENT FIELDS COMPLETELY FIXED** - Root cause was getFacilitiesByCompany() method missing energy management fields in SELECT query. Frontend was setting editingFacility from facilities list data, but energy management fields (emisRealtimeMonitoring, energyManagerFullTime, emisDescription) weren't included in the query result, causing them to be undefined. Enhanced getFacilitiesByCompany() to include all energy management and process system fields. Added form.register() calls to connect fields to form state. Energy management subsection now properly displays and saves all values when editing facilities.
- June 24, 2025. **FACILITY UPDATE ENDPOINT AND COMPREHENSIVE ENDPOINT PROTECTION SYSTEM IMPLEMENTED** - Fixed "Unexpected token '<', "<!DOCTYPE"..." errors by adding missing PATCH /api/facilities/:id endpoint for user facility updates and PATCH /api/admin/facilities/:id for admin updates. Implemented comprehensive endpoint protection system with detailed documentation and comments to prevent future accidental endpoint removal. Added security validation to ensure users can only update facilities owned by their company. All facility CRUD operations now fully functional with proper authentication and authorization.
- June 24, 2025. **FACILITY FORMS ENERGY MANAGEMENT EDITING COMPLETELY FIXED** - Resolved critical issues with energy management field editing and validation errors in both user and admin facility forms. Fixed admin form default values that were hardcoded to false instead of using existing facility data for emisRealtimeMonitoring and energyManagerFullTime fields. Converted EMIS description fields from form.register() to controlled components using watch() and setValue() for proper data binding. Fixed string vs number validation issues on edit by ensuring proper type conversion. Energy management fields now save and load correctly in both create and edit modes for user dashboard and admin company management flows. Root cause was form reset function overwriting string default values with raw database numbers - fixed by converting numeric fields to strings in reset data.
- June 24, 2025. **FACILITY CREATION DATABASE SCHEMA FIXED** - Resolved critical database schema issue preventing facility creation with energy management fields. Root cause was missing database columns for new energy management features added to schema but not migrated to database. Added missing columns: emis_realtime_monitoring (boolean), emis_description (text), energy_manager_full_time (boolean). Facility creation now works correctly for both company owner dashboard and system admin company management flows with full energy management subsection support.
- June 24, 2025. **COMPANY REGISTRATION FLOW COMPLETELY RESTORED** - Fixed critical company name validation system that was preventing company owner registration workflow. Root cause was missing API endpoints for real-time company name checking and short name preview generation. Added comprehensive company validation endpoints: (1) GET /api/companies/check-name for real-time company name existence checking, (2) POST /api/companies/preview-shortname for dynamic short name generation with collision detection, (3) Enhanced helper functions generateShortName() and generateUniqueShortName() for consistent short name creation, (4) Fixed frontend integration to properly handle company validation responses and display auto-generated short names. Company registration now works end-to-end with proper validation messaging, conflict detection, and short name preview functionality. Tested successfully with both existing and new company names.
- June 24, 2025. **COMPLETE SYSTEM RESTORATION: APPLICATION CREATION, FACILITY FORMS, AND TEMPLATE SYSTEM FIXED** - Resolved all major system issues through comprehensive fixes: (1) Added missing POST /api/applications endpoint with complete validation and ID generation workflow, (2) Fixed database schema by adding missing energy management fields (emisRealtimeMonitoring, emisDescription, energyManagerFullTime) to facilities table, (3) Enhanced user facility form with advanced energy management fields matching admin capabilities, (4) Fixed SQL syntax error in getApplicationAssignedContractors method using proper field selection, (5) Corrected activity template system to display proper template names (Facility Readiness Assessment, Site Assessment) instead of generic names (TEst, PreActivity), (6) Aligned all process system fields between user and admin forms preventing schema mismatches, (7) Implemented complete application creation workflow with facility validation, ID generation, and proper status management, (8) Added comprehensive debugging logs throughout application creation process. Application creation successfully tested creating DEMO-001-101. Template system now shows proper FRA activity templates. Facility editing with energy management subsections now fully functional with proper database persistence.
- June 24, 2025. **COMPREHENSIVE PASSWORD SYSTEM AUDIT AND DOCUMENTATION COMPLETED** - Conducted complete review of all authentication forms and password handling throughout the system. Added comprehensive documentation and comments to all password-related functions: (1) Enhanced hashPassword function with detailed usage documentation covering all call sites, (2) Added extensive comments to comparePasswords function explaining bcrypt, legacy scrypt, and plain text migration support, (3) Documented password hashing in user registration, admin password reset, password change functionality, and team invitation flows, (4) Added comments to security settings page explaining bcrypt usage, (5) Verified consistent use of bcrypt with 10 salt rounds across all password operations. All password handling now properly documented and uses consistent bcrypt hashing with automatic migration for legacy formats.
- June 24, 2025. **CRITICAL PASSWORD AUTHENTICATION SYSTEM COMPLETELY FIXED** - Resolved major authentication issues that were preventing user login functionality. Root cause was duplicate login endpoints causing routing conflicts between server/routes.ts and server/auth.ts. Fixed by: (1) Removing duplicate login endpoint from auth.ts and consolidating all login logic in routes.ts, (2) Correcting database column references from passwordHash/password_hash to proper 'password' column name, (3) Adding missing verifyPassword method to storage layer with comprehensive bcrypt and legacy scrypt support, (4) Fixing double-hashing bug in admin password reset endpoint, (5) Enhanced login debugging with detailed password verification logging, (6) Added automatic migration logic for plain text passwords to bcrypt hashes on first login. Authentication system now properly handles both new bcrypt hashes and legacy scrypt format passwords. Login functionality fully operational for all user types including testuser50@yopmail.com with test12345 password.
- June 24, 2025. **GHOST APPLICATION ID DISPLAY SYSTEM FULLY RESTORED** - Fixed critical ghost ID display issue where system admins couldn't see deleted application IDs. Root cause was incomplete endpoint configuration and missing company data joins. Enhanced `getAllGhostApplicationIds()` method to include company names, facility names, and proper table joins. Fixed endpoint routing from `/api/admin/ghost-ids` to `/api/admin/ghost-application-ids` to match frontend calls. Added comprehensive logging and protective comments to prevent future endpoint removal. Ghost ID manager now properly displays all 4 deleted applications with complete company/facility information for system admin oversight and ID reuse prevention.
- June 24, 2025. **APPLICATION DELETION FOREIGN KEY CONSTRAINT ISSUE FIXED** - Resolved critical application deletion failure caused by missing `activityTemplateSubmissions` table cleanup. Enhanced `deleteApplication` method to properly handle all foreign key relationships before deletion, including: activity template submissions, application submissions, documents, application assignments, contractor assignments, messages, and notifications. Added comprehensive logging for each deletion step to facilitate debugging. Application deletion now works correctly for system admins without constraint violations.
- June 24, 2025. **CRITICAL ADMIN ENDPOINTS RESTORATION COMPLETED** - Systematically restored all missing admin management endpoints that were accidentally removed during development. Added comprehensive endpoint protection with detailed comments to prevent future deletion. Restored endpoints include: (1) User management: PATCH/DELETE `/api/admin/users/:id`, bulk delete `/api/admin/users/bulk-delete`, password reset `/api/admin/users/:id/reset-password`, (2) Application management: DELETE `/api/admin/applications/:id`, (3) Company management: PATCH `/api/admin/companies/:id`, (4) Ghost ID management: GET `/api/admin/ghost-ids`, POST `/api/admin/ghost-ids/clear`. All endpoints include proper authentication, role validation, and error handling. Added corresponding storage methods with foreign key constraint handling for safe user deletion. Admin interface now fully operational with complete CRUD functionality.
- June 24, 2025. **COMPREHENSIVE COMPANY EDIT FUNCTIONALITY ENHANCED** - Completely redesigned edit company dialog to match Add Company functionality with full company type switching, contractor services management, and all company fields. Features include: (1) Company type toggle between Participating and Contracting with visual selection cards, (2) Complete company information editing (name, business number, website, phone, full address with province dropdown), (3) Contractor services section with service regions and supported activities checkboxes, (4) Capital Retrofit technology options that appear when CR activity is selected, (5) Auto-clearing of CR technologies when CR activity is unchecked, (6) Enhanced dialog size and scrollable layout for comprehensive editing. Admin can now fully modify any company's type, services, and information through the edit interface.
- June 24, 2025. **BUSINESS NUMBER FIELD PLACEHOLDER TEXT CORRECTED SYSTEM-WIDE** - Fixed incorrect placeholder text across all forms where "Business Number" fields incorrectly displayed "Business registration number" instead of "Business phone number". Updated auth registration page and admin company creation forms to show correct placeholder text. This ensures consistent user experience and prevents confusion about what information to enter in business number fields.
- June 24, 2025. **COMPLETE ADMIN COMPANY CREATION SYSTEM WITH CR TECHNOLOGY OPTIONS IMPLEMENTED** - Restored missing "Add Company" functionality to admin companies page with comprehensive creation form supporting both participating and contracting companies. Features include: (1) Company type selection (Participating vs Contracting), (2) Complete company information fields (name, business number, website, phone, address with province dropdown), (3) Contractor-specific service regions and supported activities selection, (4) Capital Retrofit technology sub-options that appear when CR activity is selected (Lighting, Solar PV, HVAC, Process Heating, Geothermal, Process Cooling and Refrigeration, Pump Driven Systems, Fan Driven Systems, Compressed Air, Building Envelope, Other), (5) Optional user assignment with role and permission selection, (6) POST endpoint `/api/admin/companies` with proper authentication, (7) `createAdminCompany` storage method with company and user creation logic, (8) Comprehensive validation and error handling. System automatically generates short names, handles password hashing for assigned users, and clears CR technologies when CR activity is unchecked. Admin can now create companies without mandatory team member assignment while maintaining all registration form functionality.
- June 24, 2025. **COMPREHENSIVE UI OPTIMIZATIONS: TEMPLATE SYSTEM, RESPONSIVE DESIGN, AND INTERFACE SCALING** - Completely restored sophisticated template system and progress bars that were broken during recent changes. Fixed critical database query error in getApplicationAssignedContractors method by simplifying Drizzle ORM query structure. Restored missing activity templates API endpoint (/api/activity-templates/:activityType) essential for template rendering. Updated AdminApplicationDetails to use same ApplicationDetails component as users, ensuring system admin sees identical interface with all template data and responses. System admin can now view application HACO12-001-102 with full template functionality and "Start Template" workflow. Implemented comprehensive responsive design solution for approvals page with mobile-first card layout (block md:hidden) and desktop table view (hidden md:block), eliminating horizontal scroll issues on mobile devices. Fixed z-index layering issue where header overlapped sidebar during horizontal scrolling by setting sidebar z-50 and header z-40, ensuring SEMI logo and navigation always remain visible above header content. Added global 90% scaling for screens ≤1440px (14-inch displays) using CSS zoom property for clean scaling without layout disruption. Fixed sidebar positioning issues and eliminated white gaps on both landing page and auth page. Template system and admin interface now fully operational with proper mobile responsiveness, correct element stacking, and optimized scaling for smaller screens.
- June 23, 2025. **COMPLETE LANDING PAGE REDESIGN FOR SEMI PROGRAM** - Completely revamped landing page to be SEMI program-specific and professional, removing all generic content. Created comprehensive sections: Hero with $50M program highlights and March 2027 deadline, Key Benefits showcasing profitability and sustainability gains, Five SEMI Activities (FRA, EAA, SEM, EMIS, CR) with proper funding amounts and descriptions, Eligibility requirements with NAICS codes 11/21/22/23/31-33/48/56, How It Works 3-step process, and strong CTA section. Built unique footer featuring Enerva Energy Solutions as service provider, Government of Alberta and Natural Resources Canada logos, program-specific contact information (1-844-407-0025, semi@eralberta.ca), and indigenous land acknowledgment. Focused entirely on Alberta industrial facilities with authentic program data and eliminated all generic references.
- June 23, 2025. **AUTHENTICATION PAGE CONTENT UPDATED** - Updated auth page welcome text to accurately reflect SEMI program information from official PDF. Changed headline to "Strategic Energy Management for Industry (SEMI)" and updated description to highlight program goals: "Elevate energy performance, strengthen expertise, and secure ongoing savings for Alberta's industrial and manufacturing facilities." Replaced generic bullet points with actual program benefits: up to 50% funding for energy-saving projects, expert training and capacity building, and reduced costs/greenhouse gas emissions. Auth page now provides accurate program representation for participants and contractors.
- June 23, 2025. **COMPLETE APPLICATION ENDPOINTS RESTORATION COMPLETED** - Systematically restored all missing application-related API endpoints that were accidentally removed during chart development. Added comprehensive application management endpoints with detailed documentation: GET /api/applications/:id (individual application details), GET /api/applications/:id/submissions (application workflow), GET /api/applications/:id/assigned-contractors (contractor management), GET /api/applications/:id/documents (document access), POST /api/applications/:id/start-phase (workflow progression), DELETE /api/applications/:id (application deletion). Implemented supporting storage methods: getApplicationAssignedContractors, getApplicationDocuments, startApplicationPhase. Added extensive code comments and section headers to prevent future accidental removal. Application details pages now functional for both system admin and company users.
- June 23, 2025. **CRITICAL FORM TEMPLATES AND APPROVAL SYSTEM RESTORATION COMPLETED** - Investigated and resolved critical missing API endpoints that were accidentally removed during recent Gantt chart development. Root cause: Missing GET endpoint for /api/admin/form-templates was preventing form builder from displaying existing templates. Fixed by adding comprehensive form template management endpoints with detailed comments to prevent future removal. Also restored missing submission review endpoints for admin approval workflow. Added extensive code documentation and section headers to identify critical API endpoints and prevent accidental removal during future development. Form builder now displays all 5 existing templates correctly and approval system fully functional.
- June 22, 2025. **ADVANCED GANTT CHART FOR PROCESSING TIME ANALYSIS IMPLEMENTED** - Completely redesigned Processing Time Analysis with sophisticated Gantt chart visualization showing individual application timelines, phases, and bottlenecks. Features include: (1) Interactive timeline view with application rows showing company/facility info, activity types, and processing phases, (2) Phase-based visualization (Application Created → Pre-Activity → Post-Activity → Review → Approval/Rejection), (3) Advanced filtering by activity type, time period, and status with overdue detection, (4) Visual phase indicators with duration tracking, SLA compliance markers at 30-day threshold, and status icons, (5) Comprehensive tooltips showing phase breakdowns, company details, and processing statistics, (6) Real-time metrics display (average processing time, total applications, overdue count), (7) Responsive design supporting 12-20 applications based on card size with sticky headers and horizontal scrolling. System now provides detailed insight into application processing bottlenecks and phase-by-phase workflow analysis for system administrators.
- June 22, 2025. **GEOGRAPHIC DISTRIBUTION CHART ENHANCED WITH COMPREHENSIVE FILTERING** - Moved chart header into component and added extensive filtering capabilities. Implemented view mode toggle (count/density), sort options (companies/applications/contractors), and contractor visibility toggle. Added responsive chart sizing based on card size (8 items for medium, 10 for large). Enhanced UI with controls panel, proper loading states, and visual indicators. Chart now displays provincial distribution with advanced filtering for improved user experience and geographic analysis insights.
- June 22, 2025. **INDUSTRY SECTOR CHART OPTIMIZATION AND CLEANUP COMPLETED** - Fixed dashboard card layout to use flexible height containers instead of fixed heights, preventing chart content from extending beyond card boundaries. Completely removed uniform height constraints from dashboard cards, allowing each chart component to determine its own optimal size based on content requirements. Enhanced Industry Sector chart by removing contractors metric (no NAICS data available), eliminated sorting functionality for simplified UI, improved legend positioning to prevent overlap with chart labels, and removed unnecessary padding elements. Chart now displays only relevant metrics (companies, applications, facilities, workforce) with proper spacing and positioning for optimal user experience.
- June 22, 2025. **PERFECTED APPLICATION STATUS DISTRIBUTION CHART WITH ENTERPRISE UI** - Fixed critical chart positioning, legend duplication, and color scheme issues. Resolved chart offset positioning to center properly on all sizes. Eliminated duplicate FRA entries in legend through custom legend component with activity deduplication. Replaced transparent/white colors with vibrant, distinct color palette: status colors (gray/blue/amber/emerald/red/purple) and coordinated deeper activity colors. Enhanced visual hierarchy with proper contrast, shadow effects, and professional gradients. Chart now displays clean sunburst visualization with proper spacing, no transparency issues on white background, and user-friendly legend showing each activity type once with total counts.
- June 22, 2025. **ADVANCED ANALYTICS CHARTS WITH COMPREHENSIVE IMPROVEMENTS COMPLETED** - Enhanced User Growth Chart with year selection navigation for historical analysis. Completely rewrote Application Trends Chart with dual view modes (yearly/monthly), stacked bars showing application type distribution (FRA, EAA, SEM, EMIS, CR), overlay trend lines for submissions/approvals, and responsive margins. Transformed Application Status Distribution into advanced sunburst chart with inner ring showing status categories and outer ring displaying activity breakdowns, fixed "unknown" activity mapping issue, enhanced tooltips with detailed breakdowns, and improved spacing for M/L chart sizes. Redesigned Facility & Company Metrics Chart to focus on facility creation growth over time with dual view modes, completion rate tracking, and real facility data integration. All charts now feature authentic database integration, enhanced tooltips with activity breakdowns, consistent navigation patterns, and professional styling suitable for internal team analytics and program tracking.
- June 22, 2025. **ENTERPRISE-GRADE ANALYTICS DASHBOARD WITH ENHANCED INDUSTRY SECTOR ANALYSIS COMPLETED** - Fixed metric cards layout to span full screen width with improved styling and proper icons (Users, Building2, FileText, Clock). Enhanced all chart components with advanced features including sophisticated tooltips, gradient fills, reference lines, and professional margins. Added bottom spacing (pb-6) to all charts to prevent grey chart areas from touching card bottoms. Created comprehensive IndustrySectorChart component with NAICS sector mapping, showing distribution across Agriculture, Mining, Utilities, Construction, Manufacturing, Transportation, and Administrative Services with company counts, contractor distribution, application volumes, and workforce metrics. Enhanced UserGrowthChart with bar size limits, improved ApplicationStatusChart with larger radius, and optimized CompanyDistributionRadar margins. Dashboard now features 9 enterprise-grade chart components with modular architecture, authentic database integration, and professional data visualization suitable for executive-level analytics and business intelligence reporting.
- June 21, 2025. **APPLICATION LIMITS DISPLAY SYSTEM FULLY RESTORED** - Completely restored missing application limits functionality after investigating removed API endpoints. Added back all required endpoints: `/api/facilities`, `/api/applications`, `/api/activity-settings`, and `/api/facilities/:id/activities`. Fixed Vite middleware interference with API routes that was causing HTML responses instead of JSON. Activity settings now properly display with limits: FRA (1 max), EAA (2 max), SEM (unlimited), EMIS (unlimited), CR (3 max). Application counts and limits correctly calculated per facility with proper color coding and clickable activity tiles for creating new applications.
- June 21, 2025. **FACILITY INFORMATION COLLECTION ISSUE FULLY RESOLVED** - Fixed critical facility display issue where company admin users (demoseven@yopmail.com) could not see their facilities on the dashboard. Root cause was missing `/api/facilities` endpoint in server routes. Added proper facilities endpoint that retrieves facilities by user's companyId with authentication. Fixed API routing issues causing HTML responses instead of JSON. Company admin can now see facility "Tester" with proper application data display and facility management interface.
- June 21, 2025. **COMPREHENSIVE PLATFORM-WIDE ANNOUNCEMENT SYSTEM COMPLETED** - Implemented complete announcement management system for system administrators to create, manage, and track platform-wide notifications. Features include: (1) Enhanced AdminDashboard with tabbed interface (Overview, Analytics, System Status), (2) SystemStatusManager component for creating announcements with scheduling, role targeting, and acknowledgment requirements, (3) AnnouncementCard component for user-friendly display, (4) Complete backend API with announcement CRUD operations, user acknowledgment tracking, and detailed analytics, (5) Database schema with system_announcements and announcement_acknowledgments tables supporting scheduled notifications, severity levels (low/medium/high/critical), and type categories (maintenance/upgrade/issue/info/urgent). System admins can now effectively communicate maintenance windows, system updates, and critical information to users with comprehensive engagement tracking and analytics.
- June 19, 2025. **CRITICAL USER DELETION FOREIGN KEY CONSTRAINT ISSUE RESOLVED** - Fixed system admin user deletion functionality that was failing due to foreign key constraints. Updated deleteAdminUser method to handle cascading references by setting referenced fields to 'deleted_user' instead of NULL to maintain referential integrity. User deletion now properly handles applications, application_submissions, documents, team_invitations, messages, and notifications tables. System admin can now successfully delete users with existing data references without database constraint violations.
- June 19, 2025. **COMPREHENSIVE ADMIN USER MANAGEMENT SYSTEM COMPLETED** - Fixed critical backend company data enrichment issue and implemented comprehensive user management features. Backend now properly returns company names and contractor status for all users via direct database queries and company lookup maps. Added bulk user selection and deletion capabilities, Excel export functionality, advanced filtering by user type (contractors/regular users), sortable columns (name, email, join date), and enhanced table interface with selection checkboxes. Export includes user name, email, phone, join date, role, company association, and status. System admin can now efficiently manage hundreds of users with proper company visibility, bulk operations, and data export capabilities.
- June 19, 2025. **GHOST APPLICATION ID PROTECTION SYSTEM FULLY OPERATIONAL** - Completed comprehensive ghost application ID protection system that prevents immediate reuse of deleted application IDs. System automatically tracks deleted application IDs in ghost_application_ids table with company, facility, activity type, and original title metadata. Application ID generation now properly checks against ghost IDs and skips them during collision detection. Fixed deleteApplication method to use proper addGhostApplicationId function with database integration via raw SQL for schema reliability. Ghost ID Manager API endpoint returns complete list of tracked ghost IDs for system admin oversight. Tested end-to-end: deleted DEMO-001-105, system correctly tracked it as ghost ID, new application properly skipped to DEMO-001-106. Complete ghost ID protection now prevents accidental reuse of deleted application IDs across entire system until explicit admin clearance.
- June 18, 2025. **ENTERPRISE-GRADE ADMIN APPLICATIONS TABLE INTERFACE COMPLETED** - Completely redesigned AdminApplicationsPage with professional table-based interface optimized for managing hundreds of applications efficiently. Removed excessive colors in favor of clean gray professional design, replaced card grid with scalable table layout showing all critical data in scannable format. Features minimal statistics cards, streamlined filtering controls, bulk selection capabilities, and alternating row colors for easy reading. Interface now suitable for enterprise-level application management with maximum information density and professional appearance.
- June 18, 2025. **SYSTEM ADMIN APPLICATION ACCESS FIXED** - Updated admin application routing to use actual user ApplicationDetails component instead of hardcoded admin version. System admin now sees exactly the same interface that users see when clicking application IDs, providing complete visibility into user experience with all template data, form fields, submissions, and contractor assignments. Removed duplicate Applications tab from AdminDashboard and fixed navigation routing for seamless admin application management.
- June 18, 2025. **INDUSTRY-STANDARD ADMIN APPROVAL SYSTEM COMPLETED** - Completely redesigned approval system with professional industry-standard interface. Created comprehensive AdminSubmissionReview.tsx with full-screen detailed review interface featuring 4-tab navigation (Overview, Form Responses, Documents, Team & Contractors). Enhanced getPendingSubmissions() and created getSubmissionDetails() to fetch complete application data including documents, template fields, and contractor assignments. Built modern table-based AdminApprovalDashboard.tsx with advanced filtering, sorting, and quick actions. System includes document download access, structured form field response display with type-specific formatting, comprehensive company/facility information, team member visibility, and formal approval workflow with review notes. Implements proper routing to detailed review pages and maintains full audit trail of approval decisions.
- June 18, 2025. **COMPREHENSIVE APPLICATION REVIEW INTERFACE WITH FULL DATA DISPLAY COMPLETED** - Created comprehensive applicationsdata.md documenting all 200+ available database fields across applications, companies, facilities, users, contractors, and submissions. Enhanced getPendingSubmissions() method with step-by-step data enrichment to retrieve complete application information from all related tables. Built full-screen review interface in AdminApprovalDashboard.tsx with 3-column layout displaying: (1) Application details with submission status and template information, (2) Complete company information including business numbers, addresses, and facility data with NAICS codes, floor area, operating hours, energy systems, (3) Full submitter contact information, contractor assignments with compliance status, and formal approval workflow. System admin can now access comprehensive review screen showing ALL available application-related data for complete oversight and informed approval decisions.
- June 18, 2025. **COMPREHENSIVE SYSTEM ADMIN APPROVAL WORKFLOW SYSTEM COMPLETED** - Implemented complete formal approval system for activity template submissions with fully operational API returning 38+ submitted applications. Fixed database architecture issues in getPendingSubmissions method using proper Drizzle ORM structure. Built comprehensive AdminApprovalDashboard.tsx with real-time statistics (pending: 17, approved: 13, rejected: 8), filtering by status, search functionality, and detailed submission review interface. Implemented complete approve/reject workflow with review notes capability, proper status management, and database persistence. System admin (demo@admin.com) can now access "Approvals" menu to review all company submissions system-wide, view complete application details with company/facility/contractor information, and formally approve or reject submissions with detailed feedback. Complete administrative oversight system now fully operational with comprehensive approval management.
- June 18, 2025. **COMPANY ADMIN APPLICATION WORKFLOW FIXED** - Resolved critical authentication and database issues preventing company admin (demoseven@yopmail.com) from accessing their applications. Fixed password hash validation, corrected requireAuth middleware to properly use session-based authentication, and added missing approval_status columns to database tables. Company admin can now successfully login, view applications list showing DEMO-001-101 (FRA application), and access individual application details with proper facility information and template status tracking. Authentication workflow now fully functional for existing company admin users.
- June 18, 2025. **SYSTEM ADMIN APPROVAL WORKFLOW SYSTEM COMPLETED** - Implemented comprehensive system admin interface with formal approval workflow for activity template submissions. Created AdminApplicationDetails.tsx for detailed application management with company/facility information, document access, and contractor assignment viewing. Created AdminApprovalDashboard.tsx for formal submission approval with filtering, search, quick approve, and detailed review capabilities including submission data preview and approval/rejection with review notes. Added backend storage methods getPendingSubmissions(), approveSubmission(), rejectSubmission(), getSubmissionDetails(), and getApplicationWithFullDetails() for complete approval system operations. Enhanced admin navigation with dedicated "Approvals" menu item. System admin can now view all applications system-wide, review submitted templates, and formally approve/reject submissions with detailed feedback and notification system.
- June 18, 2025. **NOTIFICATION TEMPLATE NAME RESOLUTION FIXED** - Resolved critical issue where contractor work completion notifications displayed "an activity" instead of specific template names. Root cause was backend getFormTemplates() returning empty array while frontend had template data available. Fixed by passing template name directly from frontend to notification API endpoint using templateName parameter. Notifications now correctly display specific template names like "TEst" and "PreActivity" when contractors complete work. Template name resolution now works reliably with frontend-to-backend data flow.
- June 18, 2025. **FINAL CONTRACTOR WORKFLOW OPTIMIZATIONS COMPLETED** - Completed all remaining contractor workflow improvements: (1) Enhanced notification template name resolution system to properly display specific template names from application_submissions table instead of generic "an activity" - now shows "TEst", "PreActivity" etc. in notifications when contractors complete work, (2) Removed overdue metrics box from contractor dashboard and implemented cleaner 2-column layout with "Completed" and "In Progress" metrics, (3) Fixed contractor completion status calculation to properly reflect company admin submission status rather than contractor saves, (4) Maintained contractor document visibility for company admins in main Documents tab, (5) Preserved contractor deduplication in applications list showing one entry per contracting company. Core contractor workflow now fully optimized with proper status tracking, clean dashboard UI, and accurate notification messaging system that references actual form template names.
- June 18, 2025. **CONTRACTOR WORKFLOW FINAL FIXES COMPLETED** - Fixed both remaining contractor workflow issues: (1) Enhanced notification system to display specific template names instead of generic "an activity" by implementing fallback logic to check both form_templates and activity_templates tables, (2) Implemented contractor document visibility for company admins by modifying getDocumentsByCompany() to include documents uploaded by contractors on company applications in the main Documents tab. Company admins now see contractor-uploaded files across all applications they own. Notification system now properly shows template names like "TEst" and "PreActivity" instead of generic messages. Document cross-visibility fully operational with proper SQL joins and deduplication.
- June 18, 2025. **CRITICAL CONTRACTOR APPLICATION PERSISTENCE BUG FIXED** - Resolved the major contractor application visibility issue where applications would disappear from account owner dashboards when team member assignments were removed. Implemented permanent historical tracking via `contractor_company_assignment_history` table that preserves company-level application assignments regardless of individual team member changes. Account owners now always see applications assigned to their contracting company, ensuring proper business continuity. Fixed PostgreSQL query result parsing to correctly handle database response structure. Complete contractor application management now functional with persistent visibility.
- June 18, 2025. **CONTRACTOR ROLE PERMISSIONS SYSTEM COMPLETED** - Fixed contractor team permission management to enable full administrative capabilities for account owners. Updated backend API endpoints to include `contractor_individual` role in all permission checks for assign/unassign/update operations. Corrected frontend display to show "Account Owner (Full Access)" instead of incorrect "view" permissions. Enhanced permission editing functionality for contractor account owners with `contractor_individual` role. Complete contractor team management now operational with proper role hierarchy recognition.
- June 17, 2025. **CONTRACTOR TEAM INVITATION EMAIL VERIFICATION FIX** - Fixed critical issue where invited contractor team members required email verification before login. Updated contractor team invitation endpoint to automatically set `isEmailVerified: true` and `emailVerifiedAt` for invited members. Contractor team members can now log in immediately after invitation without email verification step. Fixed existing contractor team member semiteammember47@yopmail.com login with Test1998* password. Complete contractor team invitation workflow now functional end-to-end.
- June 17, 2025. **CONTRACTOR APPLICATION VIEWING AND EDITING SYSTEM COMPLETED** - Implemented comprehensive contractor applications interface enabling contractors to view and edit assigned applications. Fixed contractor login authentication (semiteammember46@yopmail.com / Test1998*), resolved duplicate method issues in getContractorApplications API, and enhanced contractor dashboard with detailed application display. Contractors can now see assigned applications (TESACC-001-101) with facility info, company details, assignment permissions, and direct access to edit application forms. Complete contractor workflow now functional from login through application management.
- June 17, 2025. **CONTRACTOR ASSIGNMENT DUPLICATION ISSUE COMPLETELY RESOLVED** - Fixed critical bug where contractor assignments were accumulating duplicates instead of replacing existing assignments. Implemented proper `removeApplicationContractorAssignments` method in storage layer to clear existing assignments before adding new ones. Cleaned up 25+ duplicate assignment records from database for application TESACC-001-101. Assignment replacement logic now works correctly - selecting/deselecting contractors maintains clean list without duplicates.
- June 17, 2025. **CONTRACTOR SERVICES UPDATE PERMISSIONS FIXED** - Resolved permissions issue preventing contractor account owners from updating their services and regions. Fixed API endpoint to allow `contractor_individual` role (account owner) to edit services without requiring manager permissions. Added missing `capitalRetrofitTechnologies` variable to contractor registration endpoint. Contractor services page now fully functional for editing supported activities, service regions, and Capital Retrofit technology selections with proper code of conduct validation.
- June 17, 2025. **CONTRACTOR ASSIGNMENT SYSTEM ENHANCED WITH CR TECHNOLOGY MATCHING** - Added missing `/api/admin/contractors` endpoint to properly display all 6 registered contractors in admin portal. Enhanced Capital Retrofit activity filtering in ContractorAssignmentDialog to include sub-technology matching between facility requirements and contractor capabilities. Visual indicators now show matching CR technologies with green checkmarks and technology overlap counts. Admin contractors endpoint returns complete contractor data including supported activities, service regions, and capital retrofit technologies (Lighting, HVAC, Solar PV, etc.). Filtering logic now prioritizes contractors with matching CR technologies for more precise assignment recommendations.
- June 17, 2025. **CRITICAL API PARAMETER ORDER BUG FIXED** - Resolved system-wide API parameter order bug affecting all apiRequest calls throughout the application. Updated parameter sequence from incorrect (method, url, data) to correct (url, method, data) across all components including EnhancedFacilityForm.tsx, api.ts, NotificationBell.tsx, and application-details.tsx. This fix enables proper facility creation, team invitation, application form submission, and notification management. FRA application workflow now functions correctly with proper status progression: Draft → TEst Started → TEst Submitted → PreActivity Started.
- June 17, 2025. **COMPANY ADMIN TEAM INVITATION SYSTEM COMPLETED** - Removed role selection field from both modal and inline team invitation forms. All invited team members automatically receive "team_member" role with "viewer" permission level. Fixed critical API parameter order issue in TeamManagement.tsx where apiRequest calls used incorrect parameter sequence. Corrected all mutation functions (invite, transfer admin, permission updates, deactivation) to use proper (url, method, data) order. Simplified invitation form shows only essential fields: first name, last name, email, and optional message. Successfully tested end-to-end invitation flow with proper role assignment.
- June 17, 2025. **CONTRACTOR TEAM INVITATION SYSTEM COMPLETED** - Fixed all contractor team invitation and acceptance issues. Resolved email verification problems by automatically setting `isEmailVerified: true` for invited team members. Fixed invitation acceptance endpoint authentication issues and implemented proper bcrypt password hashing for new accounts. Complete invitation flow now works end-to-end: invitation creation with credentials → token-based acceptance → account creation with custom password → automatic login capability. All team members can now successfully join contractor teams through the invitation system.
- June 17, 2025. **CONTRACTOR TEAM MANAGEMENT SYSTEM FULLY OPERATIONAL** - Completed comprehensive contractor team management with full administrative capabilities. Fixed contractor dashboard routing to recognize all contractor role types (contractor_account_owner, contractor_manager, contractor_team_member), restored sidebar navigation menu, and resolved API authentication issues. Implemented complete team management interface with permission editing, ownership transfer with warning dialogs, member removal, and invitation acceptance/decline functionality. Account owners can now manage all team operations including transferring ownership (with role demotion warnings), editing member permissions, and handling team invitations. All contractor role types properly recognized across frontend routing, sidebar navigation, and backend API endpoints.
- June 17, 2025. **DATABASE SCHEMA SYNCHRONIZATION COMPLETED** - Resolved critical database schema mismatches in contractor team system. Updated teamInvitations table schema to use `invitedByUserId` column matching actual database structure, manually added missing contractor role enum values to PostgreSQL database, and fixed storage layer column mappings. Contractor user roles now properly assigned with VfsDO1UpkgLy1qVevGIMt updated to contractor_account_owner for company 29 and 4sQP3JUM9WuK69i2TCZsq updated to contractor_account_owner for company 30.
- June 17, 2025. **SERVICES & REGIONS PAGE ENHANCED** - Fixed checkbox state issues where currently supported activities now properly show as checked when editing. Added Capital Retrofit sub-options with 11 technology categories (Lighting, Solar PV, HVAC, Process Heating, Geothermal, Process Cooling and Refrigeration, Pump Driven Systems, Fan Driven Systems, Compressed Air, Building Envelope, Other). Updated database schema with `capital_retrofit_technologies` column and enhanced backend API to support technology storage. Improved form state management and display logic to show selected technologies under Capital Retrofit. Fixed API request parameter ordering bug in queryClient.
- June 16, 2025. **CONTRACTOR DASHBOARD RESTRUCTURED** - Completely restructured contractor dashboard with sidebar navigation replacing main page menu items. Created separate dedicated contractor pages: Applications, Services & Regions, Team Management, and Profile. Removed documents section from contractor dashboard. Updated contractor visibility status to read-only display for contractors with admin-side control for activation/deactivation via `/api/admin/contractors/:id/toggle-status` endpoint. Profile management moved to top-right dropdown. Fixed contractor applications API database error by correcting table reference from contractorAssignments to applicationAssignments.
- June 16, 2025. **CONTRACTOR REGISTRATION FULLY RESOLVED** - Fixed multiple issues: (1) Frontend form missing `codeOfConductAgreed` and `gstWcbInsuranceConfirmed` fields in data sent to backend, (2) Backend validation incorrectly requiring postal codes for contractors, (3) Contractor role assignment and dashboard redirection, (4) Company short name collision detection for unique identifiers. Complete contractor registration flow now working end-to-end.
- June 13, 2025. Initial setup

## User Preferences

Preferred communication style: Simple, everyday language.